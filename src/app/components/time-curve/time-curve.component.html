<div class="container">
  <div class="page-header">
    <h2>Time Curve - Job Statistics</h2>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading statistics...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
    <button (click)="refresh()" class="btn btn-primary">Try Again</button>
  </div>

  <div *ngIf="!loading && !error" class="content">
    <div class="controls">
      <div class="form-group">
        <label for="company-select">Select Company:</label>
        <select
          id="company-select"
          [(ngModel)]="selectedCompany"
          (change)="onCompanyChange()"
          class="company-select">
          <option *ngFor="let company of companies" [value]="company.company_name">
            {{ company.company_name }}
          </option>
        </select>
      </div>
      <button (click)="refresh()" class="btn btn-secondary">Refresh</button>
    </div>

    <div class="chart-container" *ngIf="chartOptions">
      <apx-chart
        #chart
        [series]="chartOptions.series!"
        [chart]="chartOptions.chart!"
        [xaxis]="chartOptions.xaxis!"
        [yaxis]="chartOptions.yaxis!"
        [title]="chartOptions.title!"
        [plotOptions]="chartOptions.plotOptions!"
        [dataLabels]="chartOptions.dataLabels!"
        [legend]="chartOptions.legend!"
        [tooltip]="chartOptions.tooltip!"
        [colors]="chartOptions.colors!"
        [theme]="chartOptions.theme!"
        [grid]="chartOptions.grid!"
      ></apx-chart>
    </div>

    <div class="legend-info">
      <div class="legend-item">
        <span class="legend-color" style="background-color: #F44336;"></span>
        <span>Removed Jobs (below x-axis)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background-color: #2196F3;"></span>
        <span>Existing Jobs (same since yesterday)</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background-color: #4CAF50;"></span>
        <span>New Jobs (added today)</span>
      </div>
    </div>

    <div class="chart-interaction-hint">
      Click on a bar segment to filter the job list below
    </div>

    <!-- Job List Section -->
    <div class="jobs-section">
      <div class="jobs-header">
        <h3>{{ getFilterLabel() }}</h3>
        <div class="jobs-controls">
          <button
            *ngIf="selectedDate"
            (click)="clearFilter()"
            class="btn btn-secondary btn-sm"
          >
            Clear Filter
          </button>
          <div class="page-size-control">
            <label>Show:</label>
            <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
              <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
            </select>
          </div>
        </div>
      </div>

      <div *ngIf="jobsLoading" class="jobs-loading">
        <div class="spinner-small"></div>
        <span>Loading jobs...</span>
      </div>

      <div *ngIf="jobsError" class="jobs-error">
        {{ jobsError }}
      </div>

      <div *ngIf="!jobsLoading && !jobsError && jobs.length > 0" class="jobs-list">
        <table class="jobs-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Company</th>
              <th>Level</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let job of jobs">
              <td>{{ job.title || 'N/A' }}</td>
              <td>{{ job.company_name }}</td>
              <td>{{ job.level || 'N/A' }}</td>
              <td>{{ job.location || 'N/A' }}</td>
            </tr>
          </tbody>
        </table>

        <div class="pagination" *ngIf="totalPages > 1">
          <button
            class="page-btn"
            [disabled]="currentPage === 0"
            (click)="onPageChange(0)"
          >
            First
          </button>
          <button
            class="page-btn"
            [disabled]="currentPage === 0"
            (click)="onPageChange(currentPage - 1)"
          >
            Prev
          </button>
          <button
            *ngFor="let page of pageNumbers"
            class="page-btn"
            [class.active]="page === currentPage"
            (click)="onPageChange(page)"
          >
            {{ page + 1 }}
          </button>
          <button
            class="page-btn"
            [disabled]="currentPage === totalPages - 1"
            (click)="onPageChange(currentPage + 1)"
          >
            Next
          </button>
          <button
            class="page-btn"
            [disabled]="currentPage === totalPages - 1"
            (click)="onPageChange(totalPages - 1)"
          >
            Last
          </button>
          <span class="page-info">
            Page {{ currentPage + 1 }} of {{ totalPages }} ({{ totalJobs }} jobs)
          </span>
        </div>
      </div>

      <div *ngIf="!jobsLoading && !jobsError && jobs.length === 0" class="no-jobs">
        No jobs found for the current selection
      </div>
    </div>
  </div>
</div>
